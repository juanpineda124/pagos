<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Registro de √Ålbumes</title>
    <link rel="icon" href="images/1.jpeg">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: #f8f9fa;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        select,
        button {
            margin: 5px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #aaa;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            table-layout: fixed;
            /* ‚úÖ mantiene los tama√±os fijos */
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        /* ‚úÖ NUEVO: columna # con ancho fijo */
        th:first-child,
        td:first-child {
            width: 40px;
            min-width: 60px;
            max-width: 60px;
            text-align: center;
        }

        /* ‚úÖ Fijar las siguientes columnas para que no se deformen */
        th:nth-child(2),
        td:nth-child(2) {
            width: 100px;
            /* Foto (URL) */
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: 270px;
            /* √Ålbum */
        }

        /* Ensanchar la columna de Fecha de Pago */
        th:nth-child(8),
        td:nth-child(8) {
            width: 140px;
            /* antes probablemente era ~120px */
        }

        /* Reducir la columna de Acciones */
        th:nth-child(11),
        td:nth-child(11) {
            width: 80px;
            /* puedes bajarlo a 80px si deseas */
        }

        th {
            background: #007bff;
            color: white;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select.estado {
            width: 100%;
            box-sizing: border-box;
            padding: 6px;
        }

        #resumen {
            font-weight: bold;
            font-size: 1.1em;
            text-align: right;
            margin-top: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .acciones button {
            margin: 2px;
        }

        img.preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ccc;
            display: block;
            margin: 3px auto;
            cursor: pointer;
            transition: transform .15s ease;
        }

        img.preview:hover {
            transform: scale(1.2);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: #fff;
            padding: 14px;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            text-align: center;
        }

        .modal-img {
            max-width: 80vw;
            max-height: 70vh;
            border-radius: 6px;
            display: block;
            margin: 0 auto 8px;
        }

        .modal-buttons {
            margin-top: 8px;
        }

        .modal-buttons button {
            margin: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: #007bff;
            color: #fff;
            cursor: pointer;
        }

        .modal-buttons button:hover {
            background: #0056b3;
        }

        tr.pagado {
            background-color: #388e3c !important;
            /* verde suave */
            transition: background-color 0.3s ease;
        }
    </style>
</head>

<body>
    <h1>üì¶ Registro de √Ålbumes</h1>

    <div style="text-align:center;">
        <label for="listaSelect">Seleccionar lista:</label>
        <select id="listaSelect" onchange="cambiarLista()"></select>
        <button onclick="nuevaLista()">‚ûï Nueva Lista</button>
        <button onclick="eliminarLista()">üóëÔ∏è Eliminar Lista</button>
    </div>

    <table id="tabla">
        <thead>
            <tr>
                <th>#</th>
                <th>Foto (URL)</th>
                <th>√Ålbum</th>
                <th>Cantidad</th>
                <th>Precio Unitario ($)</th>
                <th>Total ($)</th>
                <th>Pago ($)</th>
                <th>Fecha de Pago</th>
                <th>Deuda ($)</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaBody"></tbody>
    </table>

    <div style="margin-bottom: 10px;">
        <button onclick="agregarFila()">‚ûï Agregar fila</button>
        <button onclick="guardarDatos()">üíæ Guardar</button>
        <button onclick="borrarDatos()">üßπ Borrar registros</button>
    </div>

    <div id="resumen">
        üí∞ Total General: $0 &nbsp;&nbsp;|&nbsp;&nbsp;
        üíµ Total Pagos: $0 &nbsp;&nbsp;|&nbsp;&nbsp;
        ‚ùó Total Deuda: $0
    </div>

    <script>
        const tablaBody = document.getElementById("tablaBody");
        const resumen = document.getElementById("resumen");
        const listaSelect = document.getElementById("listaSelect");

        let listas = JSON.parse(localStorage.getItem("listasNombres")) || ["Lista 1"];
        let listaActual = localStorage.getItem("listaActual") || "Lista 1";

        function cargarListas() {
            listaSelect.innerHTML = "";
            listas.forEach(nombre => {
                const opt = document.createElement("option");
                opt.value = nombre;
                opt.textContent = nombre;
                if (nombre === listaActual) opt.selected = true;
                listaSelect.appendChild(opt);
            });
            cargarDatos();
        }

        function nuevaLista() {
            const nombre = prompt("Nombre de la nueva lista:");
            if (!nombre) return;
            if (listas.includes(nombre)) { alert("‚ùó Esa lista ya existe."); return; }
            listas.push(nombre);
            localStorage.setItem("listasNombres", JSON.stringify(listas));
            listaActual = nombre;
            localStorage.setItem("listaActual", listaActual);
            cargarListas();
        }

        function eliminarLista() {
            if (!listaActual) return alert("‚ùó No hay ninguna lista seleccionada.");
            const listaEliminada = listaActual;
            const confirmar = confirm(`‚ö†Ô∏è ¬øSeguro que deseas eliminar completamente la lista "${listaEliminada}"?`);
            if (!confirmar) return;
            localStorage.removeItem("registroArticulos_" + listaEliminada);
            listas = listas.filter(l => l !== listaEliminada);
            localStorage.setItem("listasNombres", JSON.stringify(listas));
            listaActual = listas[0] || "Lista 1";
            localStorage.setItem("listaActual", listaActual);
            cargarListas();
        }

        function cambiarLista() {
            listaActual = listaSelect.value;
            localStorage.setItem("listaActual", listaActual);
            cargarDatos();
        }

        function convertirDriveURL(url) {
            if (!url) return "";
            const match = url.match(/(?:file\/d\/|id=)([a-zA-Z0-9_-]{10,})/);
            if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}=s800`;
            return url;
        }

        // ‚úÖ Agregar fila con n√∫mero consecutivo autom√°tico
        function agregarFila(data = {}) {
            const tr = document.createElement("tr");

            // üî¢ N√∫mero de registro (se reenumera autom√°ticamente)
            const tdNum = document.createElement("td");
            tdNum.className = "numeroRegistro";
            tdNum.textContent = tablaBody.rows.length + 1;
            tr.appendChild(tdNum);

            // üì∏ Imagen
            const tdFoto = document.createElement("td");
            const inUrl = document.createElement("input");
            inUrl.type = "text";
            inUrl.placeholder = "Pega el enlace de la imagen";
            inUrl.value = data.imagen || "";
            tdFoto.appendChild(inUrl);

            function mostrarImagen(url) {
                if (!url.trim()) return;
                url = convertirDriveURL(url);
                let img = tdFoto.querySelector("img.preview");
                if (!img) {
                    img = document.createElement("img");
                    img.className = "preview";
                    tdFoto.appendChild(img);
                }
                img.src = url.trim();
                activarCambioImagen(img, inUrl);
                inUrl.style.display = "none";
            }

            inUrl.onchange = () => mostrarImagen(inUrl.value);
            if (data.imagen) mostrarImagen(data.imagen);
            tr.appendChild(tdFoto);

            // üéµ √Ålbum
            const tdAlbum = document.createElement("td");
            const inAlbum = document.createElement("input");
            inAlbum.type = "text";
            inAlbum.value = data.articulo || "";
            inAlbum.onchange = actualizarTotales;
            tdAlbum.appendChild(inAlbum);
            tr.appendChild(tdAlbum);

            // üî¢ Cantidad
            const tdCant = document.createElement("td");
            const inCant = document.createElement("input");
            inCant.type = "number";
            inCant.value = data.cantidad || 0;
            inCant.onchange = actualizarTotales;
            tdCant.appendChild(inCant);
            tr.appendChild(tdCant);

            // üí≤ Precio
            const tdPrecio = document.createElement("td");
            const inPrecio = document.createElement("input");
            inPrecio.type = "number";
            inPrecio.value = data.precio || 0;
            inPrecio.onchange = actualizarTotales;
            tdPrecio.appendChild(inPrecio);
            tr.appendChild(tdPrecio);

            // üßÆ Total
            const tdTotal = document.createElement("td");
            tdTotal.className = "total";
            tdTotal.textContent = "$0";
            tr.appendChild(tdTotal);

            // üíµ Pago
            const tdPago = document.createElement("td");
            const inPago = document.createElement("input");
            inPago.type = "number";
            inPago.value = data.pago || 0;
            inPago.onchange = actualizarTotales;
            tdPago.appendChild(inPago);
            tr.appendChild(tdPago);

            // üìÖ Fecha
            const tdFecha = document.createElement("td");
            const inFecha = document.createElement("input");
            inFecha.type = "date";
            inFecha.value = data.fecha || "";
            tdFecha.appendChild(inFecha);
            tr.appendChild(tdFecha);

            // ‚ùó Deuda (permite negativos)
            const tdDeuda = document.createElement("td");
            tdDeuda.className = "deuda";
            tdDeuda.textContent = "$0";
            tr.appendChild(tdDeuda);

            // üìä Estado
            const tdEstado = document.createElement("td");
            const sel = document.createElement("select");
            sel.className = "estado";
            sel.innerHTML = `
            <option ${data.estado === "Pagado" ? "selected" : ""}>Pagado</option>
            <option ${(data.estado === "No Pagado" || !data.estado) ? "selected" : ""}>No Pagado</option>`;
            tdEstado.appendChild(sel);
            tr.appendChild(tdEstado);

            // üóëÔ∏è Acciones
            const tdAcc = document.createElement("td");
            const btnDel = document.createElement("button");
            btnDel.textContent = "‚ùå";
            btnDel.onclick = function () { eliminarFila(btnDel); };
            tdAcc.appendChild(btnDel);
            tr.appendChild(tdAcc);

            tablaBody.appendChild(tr);
            actualizarTotales();
        }

        // ‚úÖ Reenumera los registros despu√©s de eliminar o cargar datos
        function actualizarNumerosRegistro() {
            const filas = tablaBody.querySelectorAll("tr");
            filas.forEach((fila, index) => {
                const celda = fila.querySelector(".numeroRegistro");
                if (celda) celda.textContent = index + 1;
            });
        }

        function eliminarFila(boton) {
            boton.closest("tr").remove();
            actualizarNumerosRegistro();
            actualizarTotales();
        }

        function activarCambioImagen(img, input) {
            img.onclick = function () {
                const modal = document.createElement("div");
                modal.className = "modal";
                const content = document.createElement("div");
                content.className = "modal-content";
                const bigImg = document.createElement("img");
                bigImg.className = "modal-img";
                bigImg.src = img.src;
                const buttons = document.createElement("div");
                buttons.className = "modal-buttons";
                const btnCambiar = document.createElement("button");
                btnCambiar.textContent = "Cambiar enlace";
                const btnCerrar = document.createElement("button");
                btnCerrar.textContent = "Cerrar";
                buttons.appendChild(btnCambiar);
                buttons.appendChild(btnCerrar);
                content.appendChild(bigImg);
                content.appendChild(buttons);
                modal.appendChild(content);
                document.body.appendChild(modal);
                btnCerrar.onclick = () => modal.remove();
                btnCambiar.onclick = () => {
                    const nueva = prompt("Pega el nuevo enlace de imagen:");
                    if (nueva) {
                        const convertida = convertirDriveURL(nueva);
                        img.src = convertida;
                        input.value = convertida;
                        bigImg.src = convertida;
                    }
                };
            };
        }

        // ‚úÖ Pinta de verde las filas con estado "Pagado" y quita el color si es "No Pagado"
        function actualizarColorFilas() {
            const filas = tablaBody.querySelectorAll("tr");
            filas.forEach(fila => {
                const estadoSelect = fila.children[9].querySelector("select");
                const estado = estadoSelect.value;

                // Agrega o quita la clase seg√∫n el estado
                if (estado === "Pagado") {
                    fila.classList.add("pagado");
                } else {
                    fila.classList.remove("pagado");
                }

                // Si el usuario cambia el estado manualmente, tambi√©n se actualiza
                estadoSelect.onchange = () => {
                    if (estadoSelect.value === "Pagado") {
                        fila.classList.add("pagado");
                    } else {
                        fila.classList.remove("pagado");
                    }
                    actualizarTotales(); // mantiene totales actualizados
                };
            });
        }

        function actualizarTotales() {
            let totalGeneral = 0, totalPagos = 0, totalDeuda = 0;
            const filas = tablaBody.querySelectorAll("tr");
            filas.forEach(fila => {
                const cantidad = parseFloat(fila.children[3].querySelector("input").value) || 0;
                const precio = parseFloat(fila.children[4].querySelector("input").value) || 0;
                const pago = parseFloat(fila.children[6].querySelector("input").value) || 0;
                const total = cantidad * precio;
                const deuda = total - pago; // ‚úÖ permite negativos
                fila.children[5].textContent = `$${total.toFixed(2)}`;
                fila.children[8].textContent = `$${deuda.toFixed(2)}`;
                totalGeneral += total;
                totalPagos += pago;
                totalDeuda += deuda;
            });
            resumen.innerHTML = `üí∞ Total General: $${totalGeneral.toFixed(2)} &nbsp;|&nbsp; üíµ Total Pagos: $${totalPagos.toFixed(2)} &nbsp;|&nbsp; ‚ùó Total Deuda: $${totalDeuda.toFixed(2)}`;

            actualizarColorFilas();
        }

        function guardarDatos() {
            const filas = tablaBody.querySelectorAll("tr");
            const datos = [];
            filas.forEach(fila => {
                const imgEl = fila.children[1].querySelector("img.preview");
                const imgSrc = imgEl ? imgEl.src : "";
                datos.push({
                    idRegistro: parseInt(fila.children[0].textContent),
                    imagen: imgSrc,
                    articulo: fila.children[2].querySelector("input").value,
                    cantidad: fila.children[3].querySelector("input").value,
                    precio: fila.children[4].querySelector("input").value,
                    pago: fila.children[6].querySelector("input").value,
                    fecha: fila.children[7].querySelector("input").value,
                    estado: fila.children[9].querySelector("select").value
                });
            });
            localStorage.setItem("registroArticulos_" + listaActual, JSON.stringify(datos));
            alert("‚úÖ Datos guardados en " + listaActual);
        }

        function cargarDatos() {
            tablaBody.innerHTML = "";
            const datos = JSON.parse(localStorage.getItem("registroArticulos_" + listaActual) || "[]");
            datos.forEach(fila => agregarFila(fila));
            actualizarNumerosRegistro(); // üî¢ Ajusta los n√∫meros despu√©s de cargar
            actualizarTotales();
            actualizarColorFilas();
        }

        function borrarDatos() {
            if (!confirm("¬øSeguro que deseas borrar todos los registros de " + listaActual + "?")) return;
            localStorage.removeItem("registroArticulos_" + listaActual);
            tablaBody.innerHTML = "";
            actualizarTotales();
        }

        cargarListas();
    </script>


</body>

</html>