<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Registro de √Ålbumes</title>
    <link rel="icon" href="images/1.jpeg">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background: #f8f9fa;
            color: #333;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        select,
        button {
            margin: 5px;
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #aaa;
            font-size: 14px;
        }

        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        /* ‚úÖ NUEVO: columna # con ancho fijo */
        th:first-child,
        td:first-child {
            width: 40px;
            min-width: 60px;
            max-width: 60px;
            text-align: center;
        }

        /* ‚úÖ Fijar las siguientes columnas para que no se deformen */
        th:nth-child(2),
        td:nth-child(2) {
            width: 100px;
            /* Foto (URL) */
        }

        th:nth-child(3),
        td:nth-child(3) {
            width: 260px;
            /* m√°s ancho */
            max-width: 260px;
            min-width: 300px;
        }

        td:nth-child(3) input {
            width: 100%;
            box-sizing: border-box;
            padding: 6px;
            font-size: 14px;
        }


        /* Ensanchar la columna de Fecha de Pago */
        th:nth-child(8),
        td:nth-child(8) {
            width: 140px;
            /* antes probablemente era ~120px */
        }

        /* Reducir la columna de Acciones */
        th:nth-child(11),
        td:nth-child(11) {
            width: 80px;
            /* puedes bajarlo a 80px si deseas */
        }

        th {
            background: #007bff;
            color: white;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select.estado {
            width: 100%;
            box-sizing: border-box;
            padding: 6px;
        }

        #resumen {
            font-weight: bold;
            font-size: 1.1em;
            text-align: right;
            margin-top: 10px;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .acciones button {
            margin: 2px;
        }

        img.preview {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ccc;
            display: block;
            margin: 3px auto;
            cursor: pointer;
            transition: transform .15s ease;
        }

        img.preview:hover {
            transform: scale(1.2);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .modal-content {
            background: #fff;
            padding: 14px;
            border-radius: 8px;
            max-width: 90vw;
            max-height: 90vh;
            text-align: center;
        }

        .modal-img {
            max-width: 80vw;
            max-height: 70vh;
            border-radius: 6px;
            display: block;
            margin: 0 auto 8px;
        }

        .modal-buttons {
            margin-top: 8px;
        }

        .modal-buttons button {
            margin: 6px;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            background: #007bff;
            color: #fff;
            cursor: pointer;
        }

        .modal-buttons button:hover {
            background: #0056b3;
        }

        tr.pagado {
            background-color: #388e3c !important;
            /* verde suave */
            transition: background-color 0.3s ease;
        }

        tr.abono {
            background-color: #fff176 !important;
            /* amarillo suave */
            transition: background-color 0.3s ease;
        }

        tr.descuento {
            background-color: #b3e5fc !important;
            /* azul suave */
            transition: background-color 0.3s ease;
        }

        /* ---------------------------------------------------------------------- */
        /* ‚úÖ MODO CELULAR AUTOM√ÅTICO (solo si pantalla es menor a 768px)          */
        /* ---------------------------------------------------------------------- */
        @media (max-width: 768px) {

            body {
                margin: 10px !important;
                padding: 5px !important;
                font-size: 14px !important;
            }

            h1 {
                font-size: 1.3em !important;
                margin-bottom: 10px !important;
            }

            /* ‚úÖ Hace la tabla deslizable */
            table {
                display: block !important;
                overflow-x: auto !important;
                white-space: nowrap !important;
            }

            th,
            td {
                padding: 6px !important;
                font-size: 13px !important;
            }

            input[type="text"],
            input[type="number"],
            input[type="date"],
            select.estado {
                padding: 12px !important;
                font-size: 16px !important;
            }

            button {
                padding: 12px 18px !important;
                font-size: 16px !important;
                margin: 4px !important;
            }

            img.preview {
                width: 60px !important;
                height: 60px !important;
            }

            /* ‚úÖ Columnas adaptadas */
            th:first-child,
            td:first-child {
                min-width: 50px !important;
            }

            th:nth-child(2),
            td:nth-child(2) {
                min-width: 130px !important;
            }

            th:nth-child(3),
            td:nth-child(3) {
                min-width: 260px !important;
                max-width: 260px !important;
            }


            th:nth-child(8),
            td:nth-child(8) {
                min-width: 140px !important;
            }

            th:nth-child(11),
            td:nth-child(11) {
                min-width: 90px !important;
            }
        }
    </style>
</head>

<body>
    <h1>üì¶ Registro de √Ålbumes</h1>

    <div style="text-align:center;">
        <label for="listaSelect">Seleccionar lista:</label>
        <select id="listaSelect" onchange="cambiarLista()"></select>
        <button onclick="nuevaLista()">‚ûï Nueva Lista</button>
        <button onclick="eliminarLista()">üóëÔ∏è Eliminar Lista</button>
        <button onclick="renombrarLista()">‚úèÔ∏è Renombrar lista</button>
    </div>

    <table id="tabla">
        <thead>
            <tr>
                <th>#</th>
                <th>Foto (URL)</th>
                <th>√Ålbum</th>
                <th>Cantidad</th>
                <th>Precio Unitario ($)</th>
                <th>Total ($)</th>
                <th>Pago ($)</th>
                <th>Fecha de Pago</th>
                <th>Deuda ($)</th>
                <th>Estado</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="tablaBody"></tbody>
    </table>

    <div style="margin-bottom: 10px;">
        <button onclick="agregarFila()">‚ûï Agregar fila</button>
        <button onclick="guardarDatos()">üíæ Guardar</button>
        <button onclick="borrarDatos()">üßπ Borrar registros</button>
        <button onclick="imprimirLista()">üñ®Ô∏è Imprimir Lista</button>
        <button onclick="guardarEnDrive()">üíæ Guardar en Drive</button>
        <button onclick="cargarDesdeDrive()">üì• Cargar desde Drive</button>

    </div>

    <div id="resumen">
        üí∞ Total General: $0 &nbsp;&nbsp;|&nbsp;&nbsp;
        üíµ Total Pagos: $0 &nbsp;&nbsp;|&nbsp;&nbsp;
        ‚ùó Total Deuda: $0
    </div>

    <script>
        /* -------------------------------------------------------------------------- */
        /* -------------------- VARIABLES GLOBALES Y CONFIG -------------------------- */
        /* -------------------------------------------------------------------------- */

        const tablaBody = document.getElementById("tablaBody");
        const resumen = document.getElementById("resumen");
        const listaSelect = document.getElementById("listaSelect");
        const URL_DRIVE_API = "https://script.google.com/macros/s/AKfycbztU3w7DqFQN1-eWv4CDnJ3HsBWQrxyD6EGK8mHJE-yMUK6iQlmYV1RNyfMtSIjzhvA/exec";

        let listas = JSON.parse(localStorage.getItem("listasNombres")) || ["Lista 1"];
        let listaActual = localStorage.getItem("listaActual") || "Lista 1";

        /* -------------------------------------------------------------------------- */
        /* --------------------------- INICIALIZAR INDEXEDDB ------------------------- */
        /* -------------------------------------------------------------------------- */

        let db;

        function iniciarDB() {
            const request = indexedDB.open("AlbumDB", 1);

            request.onupgradeneeded = function (event) {
                db = event.target.result;
                if (!db.objectStoreNames.contains("listas")) {
                    let store = db.createObjectStore("listas", { keyPath: "nombre" });
                    store.createIndex("nombre", "nombre", { unique: true });
                }
            };

            request.onsuccess = function (event) {
                db = event.target.result;
                console.log("‚úÖ IndexedDB cargada");
                cargarListas();
            };

            request.onerror = function () {
                console.error("‚ùå Error inicializando IndexedDB");
            };
        }

        iniciarDB();

        /* -------------------------------------------------------------------------- */
        /* -------------------------- GESTI√ìN DE LISTAS ----------------------------- */
        /* -------------------------------------------------------------------------- */

        function cargarListas() {
            listaSelect.innerHTML = "";
            listas.forEach(nombre => {
                const opt = document.createElement("option");
                opt.value = nombre;
                opt.textContent = nombre;
                if (nombre === listaActual) opt.selected = true;
                listaSelect.appendChild(opt);
            });

            cargarDatos();
        }

        function nuevaLista() {
            const nombre = prompt("Nombre de la nueva lista:");
            if (!nombre) return;
            if (listas.includes(nombre)) return alert("‚ùó Esa lista ya existe.");

            listas.push(nombre);
            localStorage.setItem("listasNombres", JSON.stringify(listas));
            listaActual = nombre;
            localStorage.setItem("listaActual", listaActual);

            cargarListas();
        }

        function eliminarLista() {
            if (!listaActual) return alert("‚ùó No hay lista seleccionada");

            if (!confirm("¬øEliminar lista '" + listaActual + "'?")) return;

            const tx = db.transaction(["listas"], "readwrite");
            const store = tx.objectStore("listas");
            store.delete(listaActual);

            listas = listas.filter(l => l !== listaActual);
            localStorage.setItem("listasNombres", JSON.stringify(listas));
            listaActual = listas[0] || "Lista 1";
            localStorage.setItem("listaActual", listaActual);

            cargarListas();
            alert("‚úÖ Lista eliminada");
        }

        function renombrarLista() {
            const nuevoNombre = prompt("Editar nombre:", listaActual);
            if (!nuevoNombre) return;
            if (listas.includes(nuevoNombre) && nuevoNombre !== listaActual)
                return alert("‚ùó Ese nombre ya existe.");

            const tx = db.transaction(["listas"], "readwrite");
            const store = tx.objectStore("listas");

            store.get(listaActual).onsuccess = function (event) {
                const data = event.target.result;

                // borrar viejo
                store.delete(listaActual);

                // guardar nuevo
                store.put({
                    nombre: nuevoNombre,
                    datos: data ? data.datos : []
                });

                // actualizar listas del UI
                listas[listas.indexOf(listaActual)] = nuevoNombre;
                listaActual = nuevoNombre;

                localStorage.setItem("listaActual", listaActual);
                localStorage.setItem("listasNombres", JSON.stringify(listas));

                cargarListas();
                alert("‚úÖ Lista renombrada correctamente.");
            };
        }

        function cambiarLista() {
            listaActual = listaSelect.value;
            localStorage.setItem("listaActual", listaActual);
            cargarDatos();
        }

        /* -------------------------------------------------------------------------- */
        /* ---------------------- FUNCIONES DE TABLA E IM√ÅGENES ---------------------- */
        /* -------------------------------------------------------------------------- */

        function convertirDriveURL(url) {
            if (!url) return "";
            const match = url.match(/(?:file\/d\/|id=)([a-zA-Z0-9_-]{10,})/);
            if (match && match[1]) return `https://lh3.googleusercontent.com/d/${match[1]}=s800`;
            return url;
        }

        function agregarFila(data = {}) {
            const tr = document.createElement("tr");

            // # registro
            const tdNum = document.createElement("td");
            tdNum.className = "numeroRegistro";
            tdNum.textContent = tablaBody.rows.length + 1;
            tr.appendChild(tdNum);

            // foto
            const tdFoto = document.createElement("td");
            const inUrl = document.createElement("input");
            inUrl.type = "text";
            inUrl.placeholder = "Pega el enlace";
            inUrl.value = data.imagen || "";
            tdFoto.appendChild(inUrl);

            function mostrarImagen(url) {
                url = convertirDriveURL(url.trim());
                if (!url) return;

                let img = tdFoto.querySelector("img.preview");
                if (!img) {
                    img = document.createElement("img");
                    img.className = "preview";
                    tdFoto.appendChild(img);
                }

                img.src = url;
                inUrl.value = url;
                inUrl.style.display = "none";
                activarCambioImagen(img, inUrl);
            }

            if (data.imagen) {
                mostrarImagen(data.imagen);
                if (!tdFoto.querySelector("img.preview")) {
                    let img = document.createElement("img");
                    img.className = "preview";
                    img.src = convertirDriveURL(inUrl.value.trim());
                    tdFoto.appendChild(img);
                    inUrl.style.display = "none";
                }
            }

            inUrl.onchange = () => mostrarImagen(inUrl.value);
            tr.appendChild(tdFoto);

            // album
            const tdAlbum = document.createElement("td");
            const inAlbum = document.createElement("input");
            inAlbum.value = data.articulo || "";
            inAlbum.onchange = actualizarTotales;
            tdAlbum.appendChild(inAlbum);
            tr.appendChild(tdAlbum);

            // cantidad
            const tdCant = document.createElement("td");
            const inCant = document.createElement("input");
            inCant.type = "number";
            inCant.value = data.cantidad || 0;
            inCant.onchange = actualizarTotales;
            tdCant.appendChild(inCant);
            tr.appendChild(tdCant);

            // precio
            const tdPrecio = document.createElement("td");
            const inPrecio = document.createElement("input");
            inPrecio.type = "number";
            inPrecio.value = data.precio || 0;
            inPrecio.onchange = actualizarTotales;
            tdPrecio.appendChild(inPrecio);
            tr.appendChild(tdPrecio);

            // total
            const tdTotal = document.createElement("td");
            tdTotal.className = "total";
            tdTotal.textContent = "$0";
            tr.appendChild(tdTotal);

            // pago
            const tdPago = document.createElement("td");
            const inPago = document.createElement("input");
            inPago.type = "number";
            inPago.value = data.pago || 0;
            inPago.onchange = actualizarTotales;
            tdPago.appendChild(inPago);
            tr.appendChild(tdPago);

            // fecha
            const tdFecha = document.createElement("td");
            const inFecha = document.createElement("input");
            inFecha.type = "date";
            inFecha.value = data.fecha || "";
            tdFecha.appendChild(inFecha);
            tr.appendChild(tdFecha);

            // deuda
            const tdDeuda = document.createElement("td");
            tdDeuda.className = "deuda";
            tdDeuda.textContent = "$0";
            tr.appendChild(tdDeuda);

            // estado
            const tdEstado = document.createElement("td");
            const sel = document.createElement("select");
            sel.className = "estado";
            sel.innerHTML = `
                <option value="Pagado" ${data.estado === "Pagado" ? "selected" : ""}>Pagado</option>
                <option value="Abono" ${data.estado === "Abono" ? "selected" : ""}>Abono</option>
                <option value="Descuento" ${data.estado === "Descuento" ? "selected" : ""}>Descuento</option>
                <option value="No Pagado" ${(data.estado === "No Pagado" || !data.estado) ? "selected" : ""}>No Pagado</option>`;
            tdEstado.appendChild(sel);
            tr.appendChild(tdEstado);
            sel.onchange = actualizarColorFilas;

            // eliminar
            const tdAcc = document.createElement("td");
            const btnDel = document.createElement("button");
            btnDel.textContent = "‚ùå";
            btnDel.onclick = () => eliminarFila(btnDel);
            tdAcc.appendChild(btnDel);
            tr.appendChild(tdAcc);

            tablaBody.appendChild(tr);
            actualizarTotales();
        }

        function actualizarNumerosRegistro() {
            tablaBody.querySelectorAll("tr").forEach((fila, i) => {
                fila.querySelector(".numeroRegistro").textContent = i + 1;
            });
        }

        function eliminarFila(btn) {
            btn.closest("tr").remove();
            actualizarNumerosRegistro();
            actualizarTotales();
        }

        function activarCambioImagen(img, input) {
            img.onclick = function () {
                const modal = document.createElement("div");
                modal.className = "modal";

                const cont = document.createElement("div");
                cont.className = "modal-content";

                const big = document.createElement("img");
                big.className = "modal-img";
                big.src = img.src;

                const btns = document.createElement("div");
                btns.className = "modal-buttons";

                const c1 = document.createElement("button");
                c1.textContent = "Cambiar enlace";

                const c2 = document.createElement("button");
                c2.textContent = "Cerrar";

                btns.appendChild(c1);
                btns.appendChild(c2);
                cont.appendChild(big);
                cont.appendChild(btns);
                modal.appendChild(cont);
                document.body.appendChild(modal);

                c2.onclick = () => modal.remove();
                c1.onclick = () => {
                    const nueva = prompt("Pega el nuevo enlace:");
                    if (nueva) {
                        const conv = convertirDriveURL(nueva);
                        img.src = conv;
                        input.value = conv;
                        big.src = conv;
                    }
                };
            };
        }

        function actualizarColorFilas() {
            tablaBody.querySelectorAll("tr").forEach(fila => {
                const estado = fila.children[9].querySelector("select").value;
                fila.classList.remove("pagado", "abono", "descuento");

                if (estado === "Pagado") fila.classList.add("pagado");
                else if (estado === "Abono") fila.classList.add("abono");
                else if (estado === "Descuento") fila.classList.add("descuento");
            });
        }

        function actualizarTotales() {
            let total = 0, pagos = 0, deuda = 0;

            tablaBody.querySelectorAll("tr").forEach(fila => {
                const c = Number(fila.children[3].querySelector("input").value) || 0;
                const p = Number(fila.children[4].querySelector("input").value) || 0;
                const pg = Number(fila.children[6].querySelector("input").value) || 0;

                const t = c * p;
                const d = t - pg;

                fila.children[5].textContent = "$" + t.toFixed(2);
                fila.children[8].textContent = "$" + d.toFixed(2);

                total += t;
                pagos += pg;
                deuda += d;
            });

            resumen.innerHTML = `üí∞ Total General: $${total.toFixed(2)} 
      | üíµ Total Pagos: $${pagos.toFixed(2)} 
      | ‚ùó Total Deuda: $${deuda.toFixed(2)}`;

            actualizarColorFilas();
        }

        /* -------------------------------------------------------------------------- */
        /* -------------------------  GUARDAR EN INDEXEDDB  -------------------------- */
        /* -------------------------------------------------------------------------- */

        function guardarDatos() {
            const filas = tablaBody.querySelectorAll("tr");
            const datos = [];

            filas.forEach(fila => {
                datos.push({
                    idRegistro: Number(fila.children[0].textContent),
                    imagen: fila.children[1].querySelector("input").value || "",
                    articulo: fila.children[2].querySelector("input").value,
                    cantidad: fila.children[3].querySelector("input").value,
                    precio: fila.children[4].querySelector("input").value,
                    pago: fila.children[6].querySelector("input").value,
                    fecha: fila.children[7].querySelector("input").value,
                    estado: fila.children[9].querySelector("select").value
                });
            });

            const tx = db.transaction(["listas"], "readwrite");
            const store = tx.objectStore("listas");

            store.put({ nombre: listaActual, datos });

            tx.oncomplete = () => alert("‚úÖ Lista guardada sin l√≠mite (IndexedDB)");
            tx.onerror = () => alert("‚ùó Error guardando en IndexedDB");
        }

        /* -------------------------------------------------------------------------- */
        /* -------------------------  CARGAR DESDE INDEXEDDB ------------------------- */
        /* -------------------------------------------------------------------------- */

        function cargarDatos() {
            if (!db) return;

            tablaBody.innerHTML = "";

            const tx = db.transaction(["listas"], "readonly");
            const store = tx.objectStore("listas");

            const req = store.get(listaActual);

            req.onsuccess = function (event) {
                const data = event.target.result;

                if (!data || !data.datos) {
                    actualizarTotales();
                    return;
                }

                data.datos.forEach(f => agregarFila(f));

                actualizarNumerosRegistro();
                actualizarTotales();
            };
        }

        /* -------------------------------------------------------------------------- */
        /* ----------------------------- BORRAR LISTA -------------------------------- */
        /* -------------------------------------------------------------------------- */

        function borrarDatos() {
            if (!confirm("¬øBorrar todos los registros de esta lista?")) return;

            const tx = db.transaction(["listas"], "readwrite");
            const store = tx.objectStore("listas");
            store.delete(listaActual);

            tx.oncomplete = () => {
                tablaBody.innerHTML = "";
                actualizarTotales();
                alert("‚úÖ Lista borrada");
            };
        }

        /* -------------------------------------------------------------------------- */
        /* --------------------------- DRIVE (sin cambios) --------------------------- */
        /* -------------------------------------------------------------------------- */

        function imprimirLista() {
            // ‚úÖ Obtener copia de la tabla
            const tablaOriginal = document.getElementById("tabla");
            const tablaClonada = tablaOriginal.cloneNode(true);

            // ‚úÖ Convertir inputs y selects a texto visible
            tablaClonada.querySelectorAll("tr").forEach(fila => {
                fila.querySelectorAll("td").forEach((celda, index) => {

                    const input = celda.querySelector("input");
                    const select = celda.querySelector("select");
                    const img = celda.querySelector("img");

                    // üìå Si es una imagen, se mantiene tal cual
                    if (img) return;

                    // üìå Si es un input ‚Üí reemplazar por su valor
                    if (input) {
                        const texto = document.createElement("span");
                        texto.textContent = input.value || "";
                        celda.innerHTML = "";
                        celda.appendChild(texto);
                    }

                    // üìå Si es un select ‚Üí mostrar su opci√≥n seleccionada
                    if (select) {
                        const texto = document.createElement("span");
                        texto.textContent = select.value;
                        celda.innerHTML = "";
                        celda.appendChild(texto);
                    }
                });
            });

            // ‚úÖ Copiar el resumen
            const resumenHTML = document.getElementById("resumen").outerHTML;

            // ‚úÖ Crear ventana de impresi√≥n
            const ventana = window.open("", "_blank");

            ventana.document.write(`
        <html>
        <head>
            <title>Imprimir - ${listaActual}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 30px;
                }

                /* ‚úÖ Forzar colores exactos en impresi√≥n */
                * {
                    -webkit-print-color-adjust: exact !important;
                    print-color-adjust: exact !important;
                }

                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    border: 1px solid #333;
                    padding: 8px;
                    text-align: center;
                }
                th {
                    background: #007bff !important;
                    color: white !important;
                }

                img {
                    width: 60px;
                    height: 60px;
                    object-fit: cover;
                }

                /* ‚úÖ Colores fuertes para impresi√≥n */
                tr.pagado { background-color: #2e7d32 !important; color: white !important; }
                tr.abono { background-color: #fdd835 !important; }
                tr.descuento { background-color: #4fc3f7 !important; }

            </style>
        </head>
        <body>
            <h2>üìã Lista: ${listaActual}</h2>
            ${tablaClonada.outerHTML}
            ${resumenHTML}
        </body>
        </html>
    `);

            ventana.document.close();
            ventana.print();
        }

        function guardarEnDrive() {
            const datos = {
                nombre: listaActual,      // nombre del archivo
                data: obtenerDatosTabla() // tu JSON
            };

            fetch(URL_DRIVE_API, {
                method: "POST",
                body: JSON.stringify(datos)
            })
                .then(r => r.text())
                .then(res => alert("‚úÖ Datos guardados en Drive: " + res))
                .catch(err => alert("‚ùó Error: " + err));
        }

        function obtenerDatosTabla() {
            const filas = tablaBody.querySelectorAll("tr");
            const datos = [];

            filas.forEach(fila => {
                datos.push({
                    imagen: fila.children[1].querySelector("img")?.src || "",
                    articulo: fila.children[2].querySelector("input").value,
                    cantidad: fila.children[3].querySelector("input").value,
                    precio: fila.children[4].querySelector("input").value,
                    pago: fila.children[6].querySelector("input").value,
                    fecha: fila.children[7].querySelector("input").value,
                    estado: fila.children[9].querySelector("select").value
                });
            });

            return datos;
        }

        function cargarDesdeDrive() {
            fetch(URL_DRIVE_API + "?mode=list")
                .then(r => r.json())
                .then(json => {

                    if (!json.ok) {
                        alert("‚ùó Error al obtener lista: " + json.message);
                        return;
                    }

                    const lista = json.archivos;

                    if (!Array.isArray(lista) || lista.length === 0) {
                        alert("‚ùó No hay archivos guardados en Drive.");
                        return;
                    }

                    const seleccion = prompt(
                        "üìÇ Archivos disponibles en Drive:\n\n" +
                        lista.map((n, i) => `${i + 1}. ${n}`).join("\n") +
                        "\n\nEscribe el n√∫mero del archivo que deseas cargar:"
                    );

                    const index = parseInt(seleccion) - 1;

                    if (isNaN(index) || !lista[index]) {
                        alert("‚ùó Selecci√≥n inv√°lida.");
                        return;
                    }

                    const archivoElegido = lista[index];

                    fetch(URL_DRIVE_API + "?mode=load&file=" + encodeURIComponent(archivoElegido))
                        .then(r => r.json())
                        .then(jsonLoad => {

                            if (!jsonLoad.ok) {
                                alert("‚ùó Error al cargar: " + jsonLoad.message);
                                return;
                            }

                            const datos = jsonLoad.data;

                            tablaBody.innerHTML = "";

                            // ‚úÖ RECONSTRUIR DATOS EN EL FORMATO QUE GUARDA guardarDatos()
                            datos.forEach((fila, i) => {
                                agregarFila({
                                    idRegistro: i + 1,
                                    imagen: fila.imagen || "",
                                    articulo: fila.articulo || "",
                                    cantidad: fila.cantidad || 0,
                                    precio: fila.precio || 0,
                                    pago: fila.pago || 0,
                                    fecha: fila.fecha || "",
                                    estado: fila.estado || "No Pagado"
                                });
                            });

                            actualizarNumerosRegistro();
                            actualizarTotales();

                            alert("‚úÖ Archivo cargado en tabla. Ahora ya puedes usar GUARDAR para guardarlo en local.");
                        })
                        .catch(err => alert("‚ùó Error al cargar archivo: " + err));
                })
                .catch(err => {
                    alert("‚ùó Error al obtener lista: " + err);
                });
        }

        cargarListas();
    </script>


</body>

</html>